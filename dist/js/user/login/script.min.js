$(function(){var e=new Page;dept=session().get("dept");var t={guid:"",getImageCode:function(){var e={clientType:constant().clientType,machineNo:guid,dept:dept};$.post(constant().url+"/user/register/pictureCode",e,function(e,i){if("success"==i&&"0"==e.resultCode){var a=constant().url+e.data.pictureCode;template().renduTemplate("templateImageCode","imageCon",a),$("input,select,textarea").on("blur",function(){_this=$(this);var e=_this.parent().parent(),i=e.find(".validation"),a="validate-success",s="validate-failed";validate().vd(_this,e,i,a,s,!1),t.addEvent(_this,e,i),""==$("#txtTel").val()&&(e.addClass("validate-failed").removeClass("validate-success"),i.html(this.placeholder))}),$("input,select,textarea").on("focus",function(){var e=$(this).parent().parent();e.removeClass(validate().vdFailed);var t=e.find(".validation");t.html(""),$("#loginTip").hide(),$("#submit").removeClass("disabled"),$("#submit").attr("disabled",!1)})}})},addEvent:function(e,i,a){return"txtTel"==e.attr("id")&&!i.hasClass("validate-failed")&&strUtil().trim(e.val()).length>0?void t.getPhoneIsTrue(e):"txtCode"==e.attr("id")&&!i.hasClass("validate-failed")&&strUtil().trim(e.val()).length>0?void t.getCodeIsTrue(e):void 0},getPhoneIsTrue:function(e){var t=strUtil().trim(e.val()),i=e.parent().parent(),a=i.find(".validation"),s={clientType:constant().clientType,mobileNo:t,dept:dept};$.post(constant().url+"/pc/login/validateMobileExist",s,function(e,t){"success"==t&&"0"==e.resultCode&&("1"==e.data.isMobileExist?i.addClass("validate-success").removeClass("validate-failed"):(i.addClass("validate-failed").removeClass("validate-success"),a.html("您输入的账户不存在！")))})},getCodeIsTrue:function(e){var i=e.val(),a=e.parent().parent(),s=a.find(".validation"),l={clientType:constant().clientType,machineNo:guid,pictureCode:i,dept:dept};$.post(constant().url+"/pc/login/validatePicCode",l,function(e,i){"success"==i&&"0"==e.resultCode&&("1"==e.data.isPicCodeRight?a.addClass("validate-success").removeClass("validate-failed"):(a.addClass("validate-failed").removeClass("validate-success"),s.html("输入的验证码不正确"),t.getImageCode()))})},initLogin:function(){t.getImageCode()},testLogin:function(e,i,a){var s={clientType:constant().clientType,machineNo:guid,mobileNo:e,password:i,pictureCode:a,dept:dept};$.post(constant().url+"/user/login/login",s,function(i,a){if("success"==a)if("0"==i.resultCode){session().setCookie("ltn-sessionId",i.data.sessionKey),session().set("login",e),session().set("sessionKey",i.data.sessionKey);var s=Url.getSearchParts("url")||"/";Util.updateUserType(function(){Util.updateUserInfo(function(){if(s.indexOf(".php")!=-1)window.location.href=s;else if(user().getUserType()){var e=decodeURIComponent(urlUtil(location.href).get("url"));user().goBack("/",e)}else{var e=decodeURIComponent(urlUtil(location.href).get("url"));user().isNameAuth()?user().goBack("/",e):user().goBack("/html/user/realname",e)}},s)},s)}else{var l;l=user().testResultCode(i.resultCode),"10000004"==i.resultCode?($("#loginTip1").show(),$("#loginTip1 .wran-tip").html("输入的账号和密码不匹配")):"10000041"==i.resultCode&&($("#loginTip2").show(),$("#loginTip2 .wran-tip").html("验证码失效，请重新获取!")),t.initLogin()}})},init:function(){e.setTitle("欢迎登录"),guid=strUtil().getGuid(),t.getImageCode()}};t.init(),$("#imageCode").on("click",function(){t.getImageCode()}),$("#submit").on("click",function(){if(user().testSubmit(t.addEvent),0!=$("#form").find(".validate-failed").length)return!1;var e=strUtil().trim($("#txtTel").val()),i=$("#txtPsd").val(),a=strUtil().trim($("#txtCode").val());t.testLogin(e,i,a)}),""==$("#txtTel").val()&&($("#submit").addClass("disabled"),$("#submit").attr("disabled",!0))});